function CodeGeneratorPassTests(display) {
{{testing_display_and_audio.js}}
{{code_generator_pass.js}}
{{machine.js}}

  // globals reset for each test
  var machine;
  var typeManager;
  var codeGeneratorPass;
  var io;
  var display;
  var audio;
  var logger;

  var expectations = [
    {
      description: "single global string",
      run: function() {
        assert(codeGeneratorPass.printString("Hello World!", true, false),
	       "prints Hello World!");
        assert(codeGeneratorPass.finalize(), "validates");

	machine.go();
      },
      calls: [
        ["sendUpdates"],
        ["print", "Hello World!\n"],
        ["sendUpdates"]
      ],
      errors: []
    },
    {
      // TOTAL = 0
      // FOR N = 2-1 TO 10*1
      //   TOTAL = TOTAL + N
      // NEXT N

      description: "for loop",
      run: function() {
        assert(
          typeManager.typeForNumericExpression(
            typeManager.typeForGlobal("TOTAL")
          ) !== null,
          "set total type"
        );
        assert(
          typeManager.typeForNumericExpression(
            typeManager.typeForGlobal("N")
          ) !== null,
          "set N type"
        );
        assert(
          codeGeneratorPass.letStatement(
            "TOTAL",
            codeGeneratorPass.numericLiteralExpression("0")
          ),
	  "set total to zero"
        );
        assert(
          codeGeneratorPass.forStatement(
            "N",
            codeGeneratorPass.subtractionExpression(
              codeGeneratorPass.numericLiteralExpression("2"),
              codeGeneratorPass.numericLiteralExpression("1")
            ),
            codeGeneratorPass.multiplicationExpression(
              codeGeneratorPass.numericLiteralExpression("10"),
              codeGeneratorPass.numericLiteralExpression("1")
            )
          ),
          "for"
        );
        assert(
          codeGeneratorPass.letStatement(
            "TOTAL",
            codeGeneratorPass.additionExpression(
              codeGeneratorPass.variableExpression("TOTAL"),
              codeGeneratorPass.variableExpression("N")
            )
          ),
          "assignment"
        );
        assert(codeGeneratorPass.next("N"), "next");
        assert(
          codeGeneratorPass.printExp(
            codeGeneratorPass.strzBuiltinExpression(
              codeGeneratorPass.variableExpression("TOTAL")
            ),
            false,
            false
          )
        );
        assert(codeGeneratorPass.finalize(), "validates");

	machine.go();
      },
      calls: [
        ["sendUpdates"],
        ["print", "55"],
        ["sendUpdates"]
      ],
      errors: []
    },
    {
      // TOTAL = 55
      // STOTAL = "!"
      // WHILE TOTAL > 0
      //   FOR N = 1 TO 11
      //     TOTAL = TOTAL-1
      //   NEXT N
      //   STOTAL = "B"+STOTAL
      // WEND
      // PRINT STOTAL

      description: "for loop",
      run: function() {
        assert(
          typeManager.typeForNumericExpression(
            typeManager.typeForGlobal("TOTAL")
          ) !== null,
          "set total type"
        );
        assert(
          typeManager.typeForStringExpression(
            typeManager.typeForGlobal("STOTAL")
          ) !== null,
          "set stotal type"
        );
        assert(
          typeManager.typeForNumericExpression(
            typeManager.typeForGlobal("N")
          ) !== null,
          "set N type"
        );
        assert(
          codeGeneratorPass.letStatement(
            "TOTAL",
            codeGeneratorPass.numericLiteralExpression("55")
          ),
	  "set total to fifty-five"
        );
        assert(
          codeGeneratorPass.letStatement(
            "STOTAL",
            codeGeneratorPass.stringLiteralExpression("!")
          ),
	  "set stotal to band"
        );
        assert(
          codeGeneratorPass.whileStatement(
            codeGeneratorPass.boolGreaterExpression(
              codeGeneratorPass.variableExpression("TOTAL"),
              codeGeneratorPass.numericLiteralExpression("0")
            )
          ),
          "while"
        );

        assert(
          codeGeneratorPass.forStatement(
            "N",
            codeGeneratorPass.numericLiteralExpression("1"),
            codeGeneratorPass.numericLiteralExpression("11")
          ),
          "for"
        );
        assert(
          codeGeneratorPass.letStatement(
            "TOTAL",
            codeGeneratorPass.subtractionExpression(
              codeGeneratorPass.variableExpression("TOTAL"),
              codeGeneratorPass.numericLiteralExpression("1")
            )
          ),
          "assignment"
        );
        assert(codeGeneratorPass.next("N"), "next");
        assert(
          codeGeneratorPass.letStatement(
            "STOTAL",
            codeGeneratorPass.additionExpression(
              codeGeneratorPass.stringLiteralExpression("B"),
              codeGeneratorPass.variableExpression("STOTAL")
            )
          ),
          "assign stotal"
        );
        assert(codeGeneratorPass.endWhile());
        assert(
          codeGeneratorPass.printExp(
            codeGeneratorPass.variableExpression("STOTAL"),
            false,
            false
          )
        );
        assert(codeGeneratorPass.finalize(), "validates");

	machine.go();
      },
      calls: [
        ["sendUpdates"],
        ["print", "BBBBB!"],
        ["sendUpdates"]
      ],
      errors: []
    },
    {
      // STOTAL = "BBBBB!"
      // IF STOTAL != "BBBBB!"
      //   PRINT "if"
      // ELSE
      //   PRINT "else"
      // END IF

      description: "if else",
      run: function() {
        assert(
          typeManager.typeForStringExpression(
            typeManager.typeForGlobal("STOTAL")
          ) !== null,
          "set stotal type"
        );
        assert(
          codeGeneratorPass.letStatement(
            "STOTAL",
            codeGeneratorPass.stringLiteralExpression("BBBBB!")
          ),
          "set sttotal"
        );
        assert(
          codeGeneratorPass.ifStatement(
            codeGeneratorPass.boolNotEqualExpression(
              codeGeneratorPass.variableExpression("STOTAL"),
              codeGeneratorPass.stringLiteralExpression("BBBBB!")
            )
          ),
          "if"
        );
        assert(
          codeGeneratorPass.printString(
            "if",
            false,
            false
          ),
          "print that should never run"
        );
        assert(codeGeneratorPass.elseStatement());
        assert(
          codeGeneratorPass.printString(
            "else",
            false,
            false
          ),
          "print that should never run"
        );
        assert(codeGeneratorPass.endIf());
        assert(codeGeneratorPass.finalize(), "validates");

	machine.go();
      },
      calls: [
        ["sendUpdates"],
        ["print", "else"],
        ["sendUpdates"]
      ],
      errors: []
    },
    {
      description: "CINT positive",
      run: function() {
        assert(
          codeGeneratorPass.printExp(
            codeGeneratorPass.strzBuiltinExpression(
              codeGeneratorPass.cintBuiltinExpression(
                codeGeneratorPass.numericLiteralExpression("1.5")
              )
            ),
            false,
            false
          ),
          "print");
        assert(codeGeneratorPass.finalize(), "validates");

        machine.go();
      },
      calls: [
        ["sendUpdates"],
        ["print", "2"],
        ["sendUpdates"]
      ],
      errors: []
    },
    {
      description: "CINT negative",
      run: function() {
        assert(
          codeGeneratorPass.printExp(
            codeGeneratorPass.strzBuiltinExpression(
              codeGeneratorPass.cintBuiltinExpression(
                codeGeneratorPass.numericLiteralExpression("-1.5")
              )
            ),
            false,
            false
          ),
          "print");
        assert(codeGeneratorPass.finalize(), "validates");

        machine.go();
      },
      calls: [
        ["sendUpdates"],
        ["print", "-1"],
        ["sendUpdates"]
      ],
      errors: []
    },
    {
      description: "INT positive",
      run: function() {
        assert(
          codeGeneratorPass.printExp(
            codeGeneratorPass.strzBuiltinExpression(
              codeGeneratorPass.intBuiltinExpression(
                codeGeneratorPass.numericLiteralExpression("1.5")
              )
            ),
            false,
            false
          ),
          "print");
        assert(codeGeneratorPass.finalize(), "validates");

        machine.go();
      },
      calls: [
        ["sendUpdates"],
        ["print", "1"],
        ["sendUpdates"]
      ],
      errors: []
    },
    {
      description: "INT negative",
      run: function() {
        assert(
          codeGeneratorPass.printExp(
            codeGeneratorPass.strzBuiltinExpression(
              codeGeneratorPass.intBuiltinExpression(
                codeGeneratorPass.numericLiteralExpression("-1.5")
              )
            ),
            false,
            false
          ),
          "print");
        assert(codeGeneratorPass.finalize(), "validates");

        machine.go();
      },
      calls: [
        ["sendUpdates"],
        ["print", "-2"],
        ["sendUpdates"]
      ],
      errors: []
    },
    {
      description: "FIX positive",
      run: function() {
        assert(
          codeGeneratorPass.printExp(
            codeGeneratorPass.strzBuiltinExpression(
              codeGeneratorPass.fixBuiltinExpression(
                codeGeneratorPass.numericLiteralExpression("1.5")
              )
            ),
            false,
            false
          ),
          "print");
        assert(codeGeneratorPass.finalize(), "validates");

        machine.go();
      },
      calls: [
        ["sendUpdates"],
        ["print", "1"],
        ["sendUpdates"]
      ],
      errors: []
    },
    {
      description: "FIX negative",
      run: function() {
        assert(
          codeGeneratorPass.printExp(
            codeGeneratorPass.strzBuiltinExpression(
              codeGeneratorPass.fixBuiltinExpression(
                codeGeneratorPass.numericLiteralExpression("-1.5")
              )
            ),
            false,
            false
          ),
          "print");
        assert(codeGeneratorPass.finalize(), "validates");

        machine.go();
      },
      calls: [
        ["sendUpdates"],
        ["print", "-1"],
        ["sendUpdates"]
      ],
      errors: []
    },
    {
      description: "PI",
      run: function() {
        assert(
          codeGeneratorPass.ifStatement(
            codeGeneratorPass.boolGreaterExpression(
              codeGeneratorPass.absBuiltinExpression(
                codeGeneratorPass.subtractionExpression(
                  codeGeneratorPass.numericLiteralExpression("3.14159"),
                  codeGeneratorPass.piBuiltinExpression()
                )
              ),
              codeGeneratorPass.numericLiteralExpression("0.001")
            )
          ),
          "if statement");
        assert(codeGeneratorPass.printString("bad", false, false));
        assert(codeGeneratorPass.endIf());
        assert(codeGeneratorPass.finalize(), "validates");

        machine.go();
      },
      calls: [
        ["sendUpdates"],
        ["sendUpdates"]
      ],
      errors: []
    },
    {
      description: "ABS",
      run: function() {
        assert(
          codeGeneratorPass.printExp(
            codeGeneratorPass.strzBuiltinExpression(
              codeGeneratorPass.absBuiltinExpression(
                codeGeneratorPass.numericLiteralExpression("-1")
              )
            ),
            true,
            false
          ),
          "print abs of negative"
        );
        assert(
          codeGeneratorPass.printExp(
            codeGeneratorPass.strzBuiltinExpression(
              codeGeneratorPass.absBuiltinExpression(
                codeGeneratorPass.numericLiteralExpression("1")
              )
            ),
            true,
            false
          ),
          "print abs of posititive"
        );

        machine.go();
      },
      calls: [
        ["sendUpdates"],
        ["print", "1\n"],
        ["print", "1\n"],
        ["sendUpdates"]
      ],
      errors: []
    }
  ];

  function setup() {
    logger = TestingLogger();
    typeManager = TypeManager(logger);
    io = TestingDisplayAndAudio();
    display = io.display;
    audio = io.audio;
    machine = Machine(display, audio, logger);
    codeGeneratorPass = CodeGeneratorPass(typeManager, machine, logger);
    // assert setOnAudioComplete and setInputHandler were called
    io.display.clear();
  }

  function expectationToTestFunc(expectation) {
    return expectation.run;
  }

  function expectationText(expectation) {
    return expectation.run.toString();
  }

  function getCallLog() {
    return display.getLog();
  }

  function getErrorLog() {
    return logger.getLog();
  }


  var tester = MatchingTester(display, setup, expectations, expectationToTestFunc, expectationText, getCallLog, getErrorLog);
  var assert = tester.assert;
  return tester;
}
